{"dependencies":[{"name":"../core/core.js","loc":{"line":1,"column":21}}],"generated":{"js":"function t(t,e){this.shader=e,this.layer=t,this.context=t.context,this.draw=function(){},this.array_size=16,this.max_size=1024,this._indexArray=new Uint16Array(6*this.array_size),this._indexBuffer=t.context.createBuffer()}var e=require(\"../core/core.js\"),i=window.document;t.prototype={initAttributes:function(t){this.attributes=t,this._attribute_table={};for(var e=0,i=0;i<t.length;i++){var r=t[i];this._attribute_table[r.name]=r,r.bytes=r.bytes||Float32Array.BYTES_PER_ELEMENT,r.type=r.type||this.context.FLOAT,r.offset=e,r.location=this.context.getAttribLocation(this.shader,r.name),this.context.enableVertexAttribArray(r.location),e+=r.width}this.stride=e,this._attributeArray=new Float32Array(4*this.array_size*this.stride),this._attributeBuffer=this.context.createBuffer(),this._registryHoles=[],this._registrySize=0},growArrays:function(t){if(!(this.array_size>=this.max_size)){var e=Math.min(t,this.max_size),i=new Float32Array(4*e*this.stride),r=new Uint16Array(6*e);i.set(this._attributeArray),r.set(this._indexArray),this._attributeArray=i,this._indexArray=r,this.array_size=e}},registerEntity:function(t){if(0===this._registryHoles.length){if(this._registrySize>=this.max_size)throw\"Number of entities exceeds maximum limit.\";this._registrySize>=this.array_size&&this.growArrays(2*this.array_size),t._glBufferIndex=this._registrySize,this._registrySize++}else t._glBufferIndex=this._registryHoles.pop()},unregisterEntity:function(t){\"number\"==typeof t._glBufferIndex&&this._registryHoles.push(t._glBufferIndex),t._glBufferIndex=null},resetRegistry:function(){this._maxElement=0,this._registryHoles.length=0},setCurrentEntity:function(t){this.ent_offset=4*t._glBufferIndex,this.ent=t},switchTo:function(){var t=this.context;t.useProgram(this.shader),t.bindBuffer(t.ARRAY_BUFFER,this._attributeBuffer);for(var e,i=this.attributes,r=0;r<i.length;r++)e=i[r],t.vertexAttribPointer(e.location,e.width,e.type,!1,this.stride*e.bytes,e.offset*e.bytes);var s=this.texture_obj;s&&null===s.unit&&this.layer.texture_manager.bindTexture(s),this.index_pointer=0},setTexture:function(t){void 0===this.texture_obj&&(t.setToProgram(this.shader,\"uSampler\",\"uTextureDimensions\"),this.texture_obj=t)},addIndices:function(t){var e=this._indexArray,i=this.index_pointer;e[0+i]=0+t,e[1+i]=1+t,e[2+i]=2+t,e[3+i]=1+t,e[4+i]=2+t,e[5+i]=3+t,this.index_pointer+=6},renderBatch:function(){var t=this.context;t.bindBuffer(t.ARRAY_BUFFER,this._attributeBuffer),t.bufferData(t.ARRAY_BUFFER,this._attributeArray,t.STATIC_DRAW),t.bindBuffer(t.ELEMENT_ARRAY_BUFFER,this._indexBuffer),t.bufferData(t.ELEMENT_ARRAY_BUFFER,this._indexArray,t.STATIC_DRAW),t.drawElements(t.TRIANGLES,this.index_pointer,t.UNSIGNED_SHORT,0)},setViewportUniforms:function(t,e){var i=this.context;i.useProgram(this.shader),i.uniform4f(this.shader.viewport,-t._x,-t._y,t._w,t._h)},writeVector:function(t,e,i){for(var r=this._attribute_table[t],s=this.stride,a=r.offset+this.ent_offset*s,n=r.width,o=arguments.length-1,h=this._attributeArray,_=0;_<4;_++)for(var u=0;u<n;u++)h[a+s*_+u]=arguments[(n*_+u)%o+1]}},e._registerLayerTemplate(\"WebGL\",{type:\"WebGL\",options:{xResponse:1,yResponse:1,scaleResponse:1,z:0},context:null,changed_objects:[],_compileShader:function(t,e){var i=this.context,r=i.createShader(e);if(i.shaderSource(r,t),i.compileShader(r),!i.getShaderParameter(r,i.COMPILE_STATUS))throw i.getShaderInfoLog(r);return r},_makeProgram:function(t){var e=this.context,i=this._compileShader(t.fragmentCode,e.FRAGMENT_SHADER),r=this._compileShader(t.vertexCode,e.VERTEX_SHADER),s=e.createProgram();if(e.attachShader(s,r),e.attachShader(s,i),e.linkProgram(s),!e.getProgramParameter(s,e.LINK_STATUS))throw\"Could not initialise shaders\";return s.viewport=e.getUniformLocation(s,\"uViewport\"),s},getProgramWrapper:function(e,i){if(void 0===this.programs[e]){var r=new t(this,this._makeProgram(i));r.name=e,r.initAttributes(i.attributeList),r.draw=i.drawCallback,r.setViewportUniforms(this._viewportRect(),this.options),this.programs[e]=r}return this.programs[e]},makeTexture:function(t,e,i){return this.texture_manager.makeTexture(t,e,i)},init:function(){if(!e.support.webgl)return e.trigger(\"NoWebGL\"),void e.stop();this.changed_objects=[],this.programs={};var t;(t=i.createElement(\"canvas\")).width=e.viewport.width,t.height=e.viewport.height,t.style.position=\"absolute\",t.style.left=\"0px\",t.style.top=\"0px\",t.style.zIndex=this.options.z,e.stage.elem.appendChild(t);var r;try{(r=t.getContext(\"webgl\",{premultipliedalpha:!0})||t.getContext(\"experimental-webgl\",{premultipliedalpha:!0})).viewportWidth=t.width,r.viewportHeight=t.height}catch(t){return e.trigger(\"NoWebGL\"),void e.stop()}this.context=r,this._canvas=t,r.clearColor(0,0,0,0),r.disable(r.DEPTH_TEST),r.blendFunc(r.ONE,r.ONE_MINUS_SRC_ALPHA),r.enable(r.BLEND),this.uniqueBind(\"RenderScene\",this.render),this.uniqueBind(\"ViewportResize\",this._resize),this.uniqueBind(\"InvalidateViewport\",function(){this.dirtyViewport=!0}),this.uniqueBind(\"PixelartSet\",this._setPixelart),this._setPixelart(e._pixelartEnabled),this.dirtyViewport=!0,this.texture_manager=new e.TextureManager(r,this),e._addDrawLayerInstance(this)},remove:function(){this._canvas.parentNode.removeChild(this._canvas),e._removeDrawLayerInstance(this)},_resize:function(){var t=this._canvas;t.width=e.viewport.width,t.height=e.viewport.height;var i=this.context;i.viewportWidth=t.width,i.viewportHeight=t.height},_setPixelart:function(t){var e=this.context;this.texture_filter=t?e.NEAREST:e.LINEAR},zsort:function(t,e){return t._globalZ-e._globalZ},visible_gl:[],render:function(t){t=t||this._viewportRect();var i=this.context;i.viewport(0,0,i.viewportWidth,i.viewportHeight),i.clear(i.COLOR_BUFFER_BIT|i.DEPTH_BUFFER_BIT);var r=this.programs;if(this.dirtyViewport){var s=this._viewportRect();for(var a in r)r[a].setViewportUniforms(s,this.options);this.dirtyViewport=!1}var n,o=e.map.search(t),h=0,_=o.length,u=this.visible_gl;for(u.length=0,h=0;h<_;h++)(n=o[h])._visible&&n.program&&n._drawLayer===this&&u.push(n);u.sort(this.zsort),_=u.length;var d=null;for(h=0;h<_;h++)d!==(n=u[h]).program&&(null!==d&&d.renderBatch(),(d=n.program).index_pointer=0,d.switchTo()),n.draw(),n._changed=!1;null!==d&&d.renderBatch()},dirty:function(t){},attach:function(t){t._drawContext=this.context},detach:function(t){t.program&&t.program.unregisterEntity(t)}});"},"hash":"03a4a959ee235d395c94f40b6068e582"}